<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with Multiple GeoJSON Layers, Dynamic Legend, and City Manager</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet Fullscreen CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" />
    <!-- Leaflet MiniMap CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css" />
    <!-- Open Sans Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap">
    <style>
    /* General style settings */
    body {
        margin: 0;
        padding-bottom: 50px;
        height: 100vh;
        overflow-y: auto;
        overflow-x: hidden;
        font-family: 'Open Sans', sans-serif;
    }
    /* Grid layout */
    .container {
        display: grid;
        grid-template-columns: 20% 1fr;
        grid-template-rows: auto 1fr;
        gap: 10px;
        grid-template-areas:
            "Logo Map"
            "Side-Bar Map";
        height: calc(100vh - 40px);
        width: 100vw;
        overflow: hidden; /* Taşan içeriği gizle */
    }
    /* Logo style */
    .Logo {
        grid-area: Logo;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
    }
    .Logo img {
        max-width: 80%;
        max-height: 80%;
    }
    /* Side-Bar style */
    .Side-Bar {
        grid-area: Side-Bar;
        background-color: white;
        padding: 25px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        overflow-y: auto;
    }
    .Side-Bar h1 {
        font-weight: bold;
        font-size: 12pt;
        margin: 0;
        text-align: ;
    }
    .Side-Bar p {
        font-size: 10pt;
        margin: 0;
        text-align: justify;
    }
    /* Map container style */
    .map-container {
        grid-area: Map;
        position: relative;
        height: 100%;
        width: 100%;
        overflow: hidden; /* Taşan içeriği gizle */
    }
    .map-container .leaflet-container {
        height: 100%;
        width: 100%;
    }
    
    /* Legend style */
    .legend {
        background-color: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        line-height: 1.5;
        max-height: calc(100% - 20px);
        overflow-y: auto;
    }
    .legend h4 {
        margin: 0 0 10px;
        font-size: 14px;
    }
    
    /* City manager style */
    #city-manager {
        position: absolute;
        top: 10px;
        left: 50px;
        z-index: 1000;
        background-color: white;
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #city-manager label {
        font-weight: 600;
        font-size: 10pt;
    }
    #city-manager select {
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
        .geojson-label {
            background-color: transparent;
            border: none;
            box-shadow: none;
            font-family: 'Open Sans', sans-serif;
            font-weight: bold;
            font-size: 10px;
            color: red;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
        }

        /* Media queries */
    @media (max-width: 768px) {
        .container {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr;
            grid-template-areas:
                "Logo"
                "Side-Bar"
                "Map";
        }
        .Logo {
            justify-content: ;
            align-items: ;
            height: 80px;
        }
        .Side-Bar {
            max-height: 30vh;
            overflow-y: auto;
        }
        .map-container {
            height: calc(70vh - 80px);
        }
    }
    
    .layer-selector {
        max-height: 200px;
        overflow-y: auto;
    }
    .layer-selector button {
        display: block;
        width: 100%;
        text-align: left;
        padding: 5px;
        margin: 2px 0;
        background: none;
        border: none;
        cursor: pointer;
    }
    .layer-selector button:hover {
        background-color: #f0f0f0;
    }
    .layer-info {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ccc;
    }
</style>
</head>
<body>
    <svg width="0" height="0">
    <defs>
        <pattern id="hatchPattern" width="5" height="10" patternUnits="userSpaceOnUse">
            <path d="M5,0 L5,10" style="stroke:#242424; stroke-width:1" />
        </pattern>
    </defs>
</svg>

    <div class="container">
        <!-- Logo Area -->
        <div class="Logo">
            <img src="https://upload.wikimedia.org/wikipedia/tr/4/40/Tarihi_Kentler_Birli%C4%9Fi_logo.png" alt="Logo">
        </div>
        <!-- Side Panel (Side-Bar) -->
        <div class="Side-Bar">
            <h1>Tarihi Kentler Birliği</h1>
            <p>
                 <br>
                Tarihi Kentler Birliği'nin 29 Büyükşehir Belediyesi, 37 İl Belediyesi, 372 İlçe Belediyesi ve 23 Belde Belediyesi olmak üzere toplam 461 üyesi vardır.
                <br>
            </p>
        </div>
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            <!-- City Manager -->
            <div id="city-manager">
                <label for="cities">Şehirler:</label>
                <select id="cities">
                    <!-- "Şehir seçiniz" option will be shown by default -->
                </select>
            </div>
        </div>
    </div>


    <!-- Turf JS -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet MiniMap JS -->
    <script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>
    <script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js"></script>
    <script>
        // Map center and initial zoom level
        var centerCoordinates = [39.79273915299965, 36.01606133613108];
        var zoomLevel = 6;
        var minZoomLevel = 4;

        // Map bounds (Turkey)
        var southWest = L.latLng(28.0, 5.0);
        var northEast = L.latLng(47.0, 60.0);
        var bounds = L.latLngBounds(southWest, northEast);

        // Create the map
        var map = L.map('map', {
            center: centerCoordinates,
            zoom: zoomLevel,
            minZoom: minZoomLevel,
            layers: [],
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        });

        // Base layer (mevcut kod)
        var baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://carto.com/">Carto</a>',
            noWrap: true
        }).addTo(map);
        
        // Yeni uydu görüntüsü katmanı
        var satelliteLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>'
        });
        

        // GeoJSON Layers
        var geoJSONLayers = {};

        // Function to load GeoJSON layers with formatted popups
        function loadGeoJSONLayer(name, url, style, labelProperty, useHatchPattern = false, zIndex = 0, enablePopup = false, popupContent = '') {
            fetch(url)
            .then(response => response.json())
            .then(data => {
                let layer = L.geoJSON(data, {
                    style: function (feature) {
                        let appliedStyle = { ...style };
                        
                        if (useHatchPattern) {
                            appliedStyle.fillColor = 'url(#hatchPattern)';
                            appliedStyle.fillOpacity = 1;
                        }
        
                        return appliedStyle;
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties[labelProperty]) {
                            let labelPoint;
        
                            if (feature.geometry.type === 'MultiPolygon') {
                                let largestPolygon = feature.geometry.coordinates.reduce((largest, polygon) => {
                                    let area = turf.area(turf.polygon(polygon));
                                    return area > largest.area ? { polygon, area } : largest;
                                }, { polygon: null, area: 0 }).polygon;
        
                                labelPoint = turf.centroid(turf.polygon(largestPolygon));
                            } else {
                                labelPoint = turf.centroid(feature);
                            }
        
                            L.marker(
                                [labelPoint.geometry.coordinates[1], labelPoint.geometry.coordinates[0]],
                                {
                                    icon: L.divIcon({
                                        className: 'geojson-label',
                                        html: feature.properties[labelProperty]
                                    }),
                                    interactive: false
                                }
                            ).addTo(map);
                        }
        
                        // Pop-up ekleme, enablePopup true ise
                        if (enablePopup && feature.properties) {
                            let popupContentFormatted = popupContent;
        
                            // Yer tutucuları gerçek özelliklerle değiştir
                            for (let property in feature.properties) {
                                let placeholder = `{${property}}`;
                                popupContentFormatted = popupContentFormatted.replace(new RegExp(placeholder, 'g'), feature.properties[property]);
                            }
        
                            // Temel formatlama uygula
                            popupContentFormatted = popupContentFormatted
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Kalın
                                .replace(/\*(.*?)\*/g, '<em>$1</em>') // İtalik
                                .replace(/#{1,3}(.*?)\n/g, (match, p1) => {
                                    let level = match.split('#').length - 1;
                                    return `<h${level}>${p1.trim()}</h${level}>`;
                                }) // Başlıklar
                                .replace(/\[\[(.*?)\]\]/g, '<a href="$1">$1</a>') // Bağlantılar
                                .replace(/\[\[(.*?)\|(.*?)\]\]/g, '<a href="$1">$2</a>') // Bağlantılar
                                .replace(/\{\{(.*?)\}\}/g, '<img src="$1" alt="Resim">'); // Resimler
        
                            layer.bindPopup(popupContentFormatted);
                        }
                    }
                });
        
                layer.setZIndex(zIndex);
                geoJSONLayers[name] = layer;
                geoJSONLayers[name].options.enablePopup = enablePopup;
                geoJSONLayers[name].options.popupContent = popupContent;
                updateLayerControl();
                layer.addTo(map); // Katmanı haritaya ekle
            });
        }




        // Load GeoJSON layers (replace with your GitHub URLs)
        
        var ilSinirlari = loadGeoJSONLayer("Tüm İl Sınırları", "https://raw.githubusercontent.com/mihracnar/Leaflet-Map-with-Multiple-Geojson-Layers-Dynamic-Legend-and-City-Manage-Public/3a77412da592008be7669bae5f6c03db379f4897/Geojson/tum_iller_simplified.geojson", {
        color: 'red', // Dış sınır rengi
        weight: 1.5, // Sınır kalınlığı
        dashArray: '5, 5', // Kısa çizgiler
        opacity: 1,
        fillColor: 'transparent', // İç renk, 'transparent' olarak ayarlandı
        fillOpacity: 0 // İç opaklık, görünmemesi için 0
        }, 'City', false, 9999, false);
        
        var uyebuyuksehir = loadGeoJSONLayer("Üye Büyükşehir", "https://raw.githubusercontent.com/mihracnar/Leaflet-Map-with-Multiple-Geojson-Layers-Dynamic-Legend-and-City-Manage-Public/main/Geojson/uye_buyuksehir.geojson", {
        color: 'grey',
        weight: 0,
        dashArray: '5, 5',
        opacity: 0,
        fillColor: 'grey',
        fillOpacity: 0.2
        }, 'your-label-property', true, 3, true, "<h3>{City}</h3><strong>Belediye Türü:</strong> Büyükşehir");
        
        var uyeIlmerkezilce = loadGeoJSONLayer("Üye İl Merkez İlçe", "https://raw.githubusercontent.com/mihracnar/Leaflet-Map-with-Multiple-Geojson-Layers-Dynamic-Legend-and-City-Manage-Public/519158bef5ef2c644bcc35051d1c297664c49d4c/Geojson/uye_il_merkez_ilce.geojson", {
        color: '#ff2727 ', // Dış sınır rengi
        weight: 1, // Sınır kalınlığı
        dashArray: '', // Kısa çizgiler
        opacity: 0.30,
        fillColor: '#ff2727 ', // İç renk, 'transparent' olarak ayarlandı
        fillOpacity: 0.30, // İç opaklık, görünmemesi için 0
        }, '-', false, 2, true, "<h3>{City}</h3><strong>Belediye Türü:</strong> İl Merkez İlçe");
        
        var uyeIlce = loadGeoJSONLayer("Üye İlçe", "https://raw.githubusercontent.com/mihracnar/Leaflet-Map-with-Multiple-Geojson-Layers-Dynamic-Legend-and-City-Manage-Public/c8b533873595075f696886caff1313d19dd016de/Geojson/uye_ilce.geojson", {
        color: 'white', // Dış sınır rengi
        weight: 2.5, // Sınır kalınlığı
        dashArray: '', // Kısa çizgiler
        opacity: 0.45,
        fillColor: '#07b86d', // İç renk, 'transparent' olarak ayarlandı
        fillOpacity: 0.30, // İç opaklık, görünmemesi için 0
        }, '-', false, 0, true, "<h3>{County}</h3><strong>Belediye Türü:</strong> İlçe");

        var uyeBelde = loadGeoJSONLayer("Üye Belde", "https://raw.githubusercontent.com/mihracnar/Leaflet-Map-with-Multiple-Geojson-Layers-Dynamic-Legend-and-City-Manage-Public/eb34d5274c2cd05f02ad521ad30f02c0c802af1e/Geojson/uye_belde.geojson", {
        color: '#ffffff', // Dış sınır rengi
        weight: 1, // Sınır kalınlığı
        dashArray: '', // Kısa çizgiler
        opacity: 0.5,
        fillColor: '#ffb200', // İç renk, 'transparent' olarak ayarlandı
        fillOpacity: 0.50, // İç opaklık, görünmemesi için 0
        }, '-', false, 1, true, "<h3>{belde_proper}</h3><strong>Belediye Türü:</strong> Belde");

        // Add more layers as needed


        // Katman seçici popup ve katman bilgilerini göstermek için olay dinleyicisi
        map.on('click', function(e) {
    console.log('Map clicked at:', e.latlng);  // Bu satır tıklamanın algılanıp algılanmadığını kontrol eder

    var layers = [];
    map.eachLayer(function(layer) {
        if (layer instanceof L.GeoJSON) {
            layer.eachLayer(function(feature) {
                if (feature.feature && feature.feature.geometry) {
                    var point = turf.point([e.latlng.lng, e.latlng.lat]);
                    var isInside = false;

                    if (feature.feature.geometry.type === 'Polygon') {
                        isInside = turf.booleanPointInPolygon(point, feature.feature);
                    } else if (feature.feature.geometry.type === 'MultiPolygon') {
                        isInside = feature.feature.geometry.coordinates.some(function(polygonCoords) {
                            return turf.booleanPointInPolygon(point, turf.polygon(polygonCoords));
                        });
                    }

                    if (isInside) {
                        var layerName = getLayerName(layer);
                        var layerData = geoJSONLayers[layerName];
                        if (layerData && layerData.options.enablePopup) {
                            layers.push({
                                name: layerName,
                                feature: feature.feature,
                                popupContent: layerData.options.popupContent
                            });
                        }
                    }
                }
            });
        }
    });

    console.log('Layers found:', layers);  // Bu satır bulunan katmanları kontrol eder

    if (layers.length > 0) {
        var popupContent = '<div class="layer-selector">';
        popupContent += '<h4>Katmanlar:</h4>';
        layers.forEach(function(layer, index) {
            popupContent += '<button onclick="showLayerInfo(' + index + ')">' + layer.name + '</button>';
        });
        popupContent += '</div>';
        popupContent += '<div id="layer-info" class="layer-info"></div>';

        var popup = L.popup()
            .setLatLng(e.latlng)
            .setContent(popupContent)
            .openOn(map);

        window.popupLayers = layers;
    }
});
        
        // Seçilen katman hakkında bilgi gösteren işlev
        function showLayerInfo(index) {
            var layer = window.popupLayers[index];
            var infoContent = '<h4>' + layer.name + '</h4>';
            
            // Popup içeriğini formatla
            var popupContentFormatted = layer.popupContent;
            for (var prop in layer.feature.properties) {
                var placeholder = `{${prop}}`;
                popupContentFormatted = popupContentFormatted.replace(new RegExp(placeholder, 'g'), layer.feature.properties[prop]);
            }
            
            // Temel formatlama uygula
            popupContentFormatted = popupContentFormatted
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Kalın
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // İtalik
                .replace(/#{1,3}(.*?)\n/g, (match, p1) => {
                    var level = match.split('#').length - 1;
                    return `<h${level}>${p1.trim()}</h${level}>`;
                }) // Başlıklar
                .replace(/\[\[(.*?)\]\]/g, '<a href="$1">$1</a>') // Bağlantılar
                .replace(/\[\[(.*?)\|(.*?)\]\]/g, '<a href="$1">$2</a>') // Bağlantılar
                .replace(/\{\{(.*?)\}\}/g, '<img src="$1" alt="Resim">'); // Resimler
        
            document.getElementById('layer-info').innerHTML = infoContent + popupContentFormatted;
        }


        // Layer Control
        var baseMaps = {
            "Carto Light All": baseLayer,
            "Uydu Görüntüsü": satelliteLayer
        };
        var overlayMaps = {};

        function updateLayerControl() {
            if (map.layerControl) {
                map.removeControl(map.layerControl);
            }
            for (var key in geoJSONLayers) {
                if (geoJSONLayers[key]) {
                    overlayMaps[key] = geoJSONLayers[key];
                }
            }
            map.layerControl = L.control.layers(baseMaps, overlayMaps, {position: 'topright', collapsed: false}).addTo(map);
        }

        // Legend control
        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<h4>Lejant</h4>';
            return div;
        };

        legend.addTo(map);

        function updateLegend() {
    var legendDiv = document.querySelector('.legend');
    legendDiv.innerHTML = '<h4>Lejant</h4>';
    map.eachLayer(function(layer) {
    console.log(layer.options.zIndex); // Z-Index değerlerini kontrol eder

    if (layer instanceof L.GeoJSON) {
        var layerName = getLayerName(layer);
        if (layerName) {
            var style = layer.options.style;
            var color = typeof style === 'function' ? style().color : style.color;
            var fillColor = typeof style === 'function' ? style().fillColor : style.fillColor;
            var weight = typeof style === 'function' ? style().weight : style.weight;
            var dashArray = typeof style === 'function' ? style().dashArray : style.dashArray;
            var fillOpacity = typeof style === 'function' ? style().fillOpacity : style.fillOpacity;

            var legendItem = document.createElement('div');
            legendItem.style.marginBottom = '5px';

            if (fillColor && fillOpacity !== undefined) {
                legendItem.innerHTML = `
                    <svg width="20" height="20" style="vertical-align: middle;">
                        <rect width="20" height="20" fill="${fillColor}" stroke="${color}" stroke-width="${weight}" stroke-dasharray="${dashArray}" fill-opacity="${fillOpacity}"/>
                    </svg>
                    <span style="margin-left: 5px;">${layerName}</span>
                `;
            } else if (weight > 0 && fillColor === 'transparent') {
                legendItem.innerHTML = `
                    <svg width="20" height="20" style="vertical-align: middle;">
                        <rect width="20" height="20" fill="none" stroke="${color}" stroke-width="${weight}" stroke-dasharray="${dashArray}"/>
                    </svg>
                    <span style="margin-left: 5px;">${layerName}</span>
                `;
            } else if (fillColor === 'transparent' && weight === 0) {
                legendItem.innerHTML = `
                    <svg width="20" height="20" style="vertical-align: middle;">
                        <rect width="20" height="20" fill="${fillColor}" fill-opacity="${fillOpacity}"/>
                    </svg>
                    <span style="margin-left: 5px;">${layerName}</span>
                `;
            }

            legendDiv.appendChild(legendItem);
        }
    }
});

}

        function getLayerName(layer) {
            for (var name in geoJSONLayers) {
                if (geoJSONLayers[name] === layer) {
                    return name;
                }
            }
            return null;
        }

        map.on('overlayadd', function() {
            updateLegend();
        });

        map.on('overlayremove', function() {
            updateLegend();
        });

        // Mini Map
        var miniMapLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/light_nolabels/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://carto.com/">Carto</a>'
        });

        new L.Control.MiniMap(miniMapLayer, {
            toggleDisplay: true,
            minimized: false,
            position: 'bottomleft'
        }).addTo(map);

        // Cities (Bookmark) Manager
        var cities = {
            "Şehir seçiniz": {center: centerCoordinates, zoom: zoomLevel},
            "İstanbul": {center: [41.1150, 29.0726], zoom: 9},
            "Ankara": {center: [39.9334, 32.8597], zoom: 8},
            "İzmir": {center: [38.4192, 27.1287], zoom: 8},
            "Antalya": {center: [36.8841, 30.7056], zoom: 8},
            "Adana": {center: [37.0017, 35.3289], zoom: 8}
        };

        var citySelect = document.getElementById('cities');

        var defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "Şehir seçiniz";
        defaultOption.selected = true;
        citySelect.appendChild(defaultOption);

        Object.keys(cities).forEach(function(name) {
            if (name !== "Şehir seçiniz") {
                var option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                citySelect.appendChild(option);
            }
        });

        citySelect.addEventListener('change', function() {
            var selectedCity = citySelect.value;
            var city = cities[selectedCity];
            if (city) {
                map.setView(city.center, city.zoom);
            }
        });

        // Create the fullscreen control
        var fullscreenControl = L.control.fullscreen({
            position: 'topleft', // this is the position in the corner the control will be shown
            title: 'Tam ekran modu', // this is the tooltip that will display on hover
            titleCancel: 'Tam ekran modundan çık', // this is the tooltip that will display on hover when fullscreen is active
            forceSeparateButton: true, // this forces separate button instead of combining it with zoom buttons
            forcePseudoFullscreen: true, // if true, fullscreen to page width and height
            fullscreenElement: false // Dom element to render in full screen, false by default (body)
        });
        
        // Add the fullscreen control to the map
        map.addControl(fullscreenControl);
    </script>
</body>
</html>
